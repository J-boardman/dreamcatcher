import{N as P,O as re,P as ne,s as ie,E as ae,f as T,g as j,h as R,d as F,j as V,i as oe,A as le,F as ce,G as ue,H as de,Q as he}from"../chunks/scheduler.3b07f987.js";import{S as fe,i as ve,a as pe,t as be}from"../chunks/index.c72e2f07.js";import{d as ge,w as M}from"../chunks/index.76fa2d59.js";let me=(e,t=21)=>(s=t)=>{let r="",a=s;for(;a--;)r+=e[Math.random()*e.length|0];return r};var ye=Object.defineProperty,we=(e,t,s)=>t in e?ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,k=(e,t,s)=>(we(e,typeof t!="symbol"?t+"":t,s),s),H=class{constructor(){k(this,"listeners",new Map)}subscribe(e,t){this.listeners.has(e)||this.listeners.set(e,[]),!this.listeners.get(e).includes(t)&&this.listeners.get(e).push(t)}unsubscribe(e,t){this.listeners.has(e)&&this.listeners.get(e).includes(t)&&(this.listeners.get(e).splice(this.listeners.get(e).indexOf(t),1),this.listeners.get(e).length===0&&this.listeners.delete(e))}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(s=>s(t))}},_e={broadcast:!1},xe={broadcast:!1},J=class{constructor({data:e,expiresAt:t=null}){k(this,"data"),k(this,"expiresAt"),this.data=e,this.expiresAt=t}isResolving(){return this.data instanceof Promise}hasExpired(){return this.expiresAt===null||this.expiresAt<new Date}expiresIn(e){return this.expiresAt=new Date,this.expiresAt.setMilliseconds(this.expiresAt.getMilliseconds()+e),this}},Se=class{constructor(){k(this,"elements",new Map),k(this,"event",new H)}resolve(e,t){Promise.resolve(t.data).then(s=>{if(s==null)return this.remove(e);t.data=s,this.broadcast(e,s)})}get(e){return this.elements.get(e)}set(e,t){this.elements.set(e,t),this.resolve(e,t)}remove(e,t){const{broadcast:s}={..._e,...t};s&&this.broadcast(e,void 0),this.elements.delete(e)}clear(e){const{broadcast:t}={...xe,...e};if(t)for(const s of this.elements.keys())this.broadcast(s,void 0);this.elements.clear()}has(e){return this.elements.has(e)}subscribe(e,t){this.event.subscribe(e,t)}unsubscribe(e,t){this.event.unsubscribe(e,t)}broadcast(e,t){this.event.emit(e,t)}},G={cache:new Se,errors:new H,fetcher:async e=>{const t=await fetch(e);if(!t.ok)throw Error("Not a 2XX response.");return t.json()},fallbackData:void 0,loadInitialCache:!0,revalidateOnStart:!0,dedupingInterval:2e3,revalidateOnFocus:!0,focusThrottleInterval:5e3,revalidateOnReconnect:!0,reconnectWhen:(e,{enabled:t})=>t&&typeof window<"u"?(window.addEventListener("online",e),()=>window.removeEventListener("online",e)):()=>{},focusWhen:(e,{enabled:t,throttleInterval:s})=>{if(t&&typeof window<"u"){let r=null;const a=()=>{const n=Date.now();(r===null||n-r>s)&&(r=n,e())};return window.addEventListener("focus",a),()=>window.removeEventListener("focus",a)}return()=>{}},revalidateFunction:void 0},Q={...G,force:!1},Ae={revalidate:!0,revalidateOptions:{...Q},revalidateFunction:void 0},Ee={broadcast:!1},Ie=class{constructor(e){k(this,"options"),this.options={...G,...e}}get cache(){return this.options.cache}get errors(){return this.options.errors}async requestData(e,t){return await Promise.resolve(t(e)).catch(s=>{throw this.errors.emit(e,s),s})}resolveKey(e){if(typeof e=="function")try{return e()}catch{return}return e}clear(e,t){const s={...Ee,...t};if(e==null)return this.cache.clear(s);if(!Array.isArray(e))return this.cache.remove(e,s);for(const r of e)this.cache.remove(r,s)}async revalidate(e,t){if(!e)throw new Error("[Revalidate] Key issue: ${key}");const{fetcher:s,dedupingInterval:r}=this.options,{force:a,fetcher:n,dedupingInterval:i}={...Q,fetcher:s,dedupingInterval:r,...t};if(a||!this.cache.has(e)||this.cache.has(e)&&this.cache.get(e).hasExpired()){const o=this.requestData(e,n),c=o.catch(()=>{});return this.cache.set(e,new J({data:c}).expiresIn(i)),await o}return this.getWait(e)}async mutate(e,t,s){var r;if(!e)throw new Error("[Mutate] Key issue: ${key}");const{revalidate:a,revalidateOptions:n,revalidateFunction:i}={...Ae,...s};let o;if(typeof t=="function"){let c;if(this.cache.has(e)){const l=this.cache.get(e);l.isResolving()||(c=l.data)}o=t(c)}else o=t;return this.cache.set(e,new J({data:o})),a?await((r=i==null?void 0:i(e,n))!=null?r:this.revalidate(e,n)):o}subscribeData(e,t){if(e){const s=r=>t(r);return this.cache.subscribe(e,s),()=>this.cache.unsubscribe(e,s)}return()=>{}}subscribeErrors(e,t){if(e){const s=r=>t(r);return this.errors.subscribe(e,s),()=>this.errors.unsubscribe(e,s)}return()=>{}}get(e){if(e&&this.cache.has(e)){const t=this.cache.get(e);if(!t.isResolving())return t.data}}getWait(e){return new Promise((t,s)=>{const r=this.subscribeData(e,i=>{if(r(),i!==void 0)return t(i)}),a=this.subscribeErrors(e,i=>{if(a(),i!==void 0)return s(i)}),n=this.get(e);if(n!==void 0)return t(n)})}subscribe(e,t,s,r){const{fetcher:a,fallbackData:n,loadInitialCache:i,revalidateOnStart:o,dedupingInterval:c,revalidateOnFocus:l,focusThrottleInterval:u,revalidateOnReconnect:d,reconnectWhen:m,focusWhen:y,revalidateFunction:b}={...this.options,...r},A=K=>{var L;return(L=b==null?void 0:b(this.resolveKey(e),K))!=null?L:this.revalidate(this.resolveKey(e),K)},E=()=>A({fetcher:a,dedupingInterval:c}),_=i?this.get(this.resolveKey(e)):n??void 0,O=o?E():Promise.resolve(void 0),v=_?Promise.resolve(_):O;_&&(t==null||t(_));const h=t?this.subscribeData(this.resolveKey(e),t):void 0,I=s?this.subscribeErrors(this.resolveKey(e),s):void 0,x=y(E,{throttleInterval:u,enabled:l}),g=m(E,{enabled:d});return{unsubscribe:()=>{h==null||h(),I==null||I(),x==null||x(),g==null||g()},dataPromise:v,revalidatePromise:O}}};function $(){}function Oe(e){return e()}function De(e){e.forEach(Oe)}function $e(e){return typeof e=="function"}function ke(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Ke(e,...t){if(e==null){for(const r of t)r(void 0);return $}const s=e.subscribe(...t);return s.unsubscribe?()=>s.unsubscribe():s}var D=[];function Pe(e,t){return{subscribe:N(e,t).subscribe}}function N(e,t=$){let s;const r=new Set;function a(o){if(ke(e,o)&&(e=o,s)){const c=!D.length;for(const l of r)l[1](),D.push(l,e);if(c){for(let l=0;l<D.length;l+=2)D[l][0](D[l+1]);D.length=0}}}function n(o){a(o(e))}function i(o,c=$){const l=[o,c];return r.add(l),r.size===1&&(s=t(a,n)||$),o(e),()=>{r.delete(l),r.size===0&&s&&(s(),s=null)}}return{set:a,update:n,subscribe:i}}function z(e,t,s){const r=!Array.isArray(e),a=r?[e]:e;if(!a.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const n=t.length<2;return Pe(s,(i,o)=>{let c=!1;const l=[];let u=0,d=$;const m=()=>{if(u)return;d();const b=t(r?l[0]:l,i,o);n?i(b):d=$e(b)?b:$},y=a.map((b,A)=>Ke(b,E=>{l[A]=E,u&=~(1<<A),c&&m()},()=>{u|=1<<A}));return c=!0,m(),function(){De(y),d(),c=!1}})}var Le=class extends Ie{useSWR(e,t){let s;const r=N(void 0,()=>()=>s==null?void 0:s()),a=N(void 0,()=>()=>s==null?void 0:s());re(()=>{const u=m=>{a.set(void 0),r.set(m)},d=m=>a.set(m);s||(s=this.subscribe(e,u,d,{loadInitialCache:!0,...t}).unsubscribe)}),ne(()=>s==null?void 0:s());const n=(u,d)=>this.mutate(this.resolveKey(e),u,{revalidateOptions:t,...d}),i=u=>this.revalidate(this.resolveKey(e),{...t,...u}),o=u=>this.clear(this.resolveKey(e),u),c=z([r,a],([u,d])=>u===void 0&&d===void 0),l=z([r,a],([u,d])=>u!==void 0&&d===void 0);return{data:r,error:a,mutate:n,revalidate:i,clear:o,isLoading:c,isValid:l}}},We=e=>new Le(e),Ce=We(),Fe=(e,t)=>Ce.useSWR(e,t),U=me("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",7);function Me(e){const t=new TextDecoder;return e?function(s){return t.decode(s,{stream:!0}).split(`
`).filter(a=>a!=="").map(Ne).filter(Boolean)}:function(s){return s?t.decode(s,{stream:!0}):""}}var X={text:0,function_call:1,data:2},Ne=e=>{const t=e.indexOf(":"),s=e.slice(0,t),r=Object.keys(X).find(i=>X[i]===Number(s)),a=e.slice(t+1);let n=a;if(!a)return{type:r,value:""};try{n=JSON.parse(a)}catch{console.error("Failed to parse JSON value:",a)}return{type:r,value:n}},Te=async(e,t,s,r,a,n,i,o,c)=>{var l,u,d,m;s(t.messages);const y=await fetch(e,{method:"POST",body:JSON.stringify({messages:c?t.messages:t.messages.map(({role:h,content:I,name:x,function_call:g})=>({role:h,content:I,...x!==void 0&&{name:x},...g!==void 0&&{function_call:g}})),...r.body,...(l=t.options)==null?void 0:l.body,...t.functions!==void 0&&{functions:t.functions},...t.function_call!==void 0&&{function_call:t.function_call}}),credentials:r.credentials,headers:{...r.headers,...(u=t.options)==null?void 0:u.headers},...n!==null&&{signal:n.signal}}).catch(h=>{throw s(a),h});if(o)try{await o(y)}catch(h){throw h}if(!y.ok)throw s(a),new Error(await y.text()||"Failed to fetch the chat response.");if(!y.body)throw new Error("The response body is empty.");let b="";const A=new Date,E=U(),_=y.body.getReader(),O=Me();let v={id:E,createdAt:A,content:"",role:"assistant"};for(;;){const{done:h,value:I}=await _.read();if(h)break;if(b+=O(I),b.indexOf("{")!==-1){const g=/(.*?)(?:({"function_call".*?}})(.*))?$/gs.exec(b);v.content=`${(d=g==null?void 0:g[1])!=null?d:""}${(m=g==null?void 0:g[3])!=null?m:""}`,v.function_call=g==null?void 0:g[2]}else v.content=b;if(s([...t.messages,{...v}]),n===null){_.cancel();break}}if(typeof v.function_call=="string"){const h=JSON.parse(v.function_call).function_call;v.function_call=h,s([...t.messages,{...v}])}return i&&i(v),v},je=0,B={};function Re({api:e="/api/chat",id:t,initialMessages:s=[],initialInput:r="",sendExtraMessageFields:a,experimental_onFunctionCall:n,onResponse:i,onFinish:o,onError:c,credentials:l,headers:u,body:d}={}){const m=t||`chat-${je++}`,y=`${e}|${m}`,{data:b,mutate:A,isLoading:E}=Fe(y,{fetcher:()=>B[y]||s,fallbackData:s}),_=M(!1);b.set(s);const O=p=>(B[y]=p,A(p)),v=b;let h=null;const I={credentials:l,headers:u,body:d},x=M(void 0);async function g(p){try{for(x.set(void 0),_.set(!0),h=new AbortController;;){const f=await Te(e,p,O,I,P(v),h,o,i,a);if(f.function_call===void 0||typeof f.function_call=="string")break;if(n){const w=f.function_call,S=await n(P(v),w);if(S===void 0)break;p=S}}return h=null,null}catch(f){if(f.name==="AbortError")return h=null,null;c&&f instanceof Error&&c(f),x.set(f)}finally{_.set(!1)}}const K=async(p,{options:f,functions:w,function_call:S}={})=>{p.id||(p.id=U());const W={messages:P(v).concat(p),options:f,...w!==void 0&&{functions:w},...S!==void 0&&{function_call:S}};return g(W)},L=async({options:p,functions:f,function_call:w}={})=>{const S=P(v);if(S.length===0)return null;const W=S.at(-1);if((W==null?void 0:W.role)==="assistant"){const se={messages:S.slice(0,-1),options:p,...f!==void 0&&{functions:f},...w!==void 0&&{function_call:w}};return g(se)}const te={messages:S,options:p,...f!==void 0&&{functions:f},...w!==void 0&&{function_call:w}};return g(te)},Y=()=>{h&&(h.abort(),h=null)},Z=p=>{O(p)},C=M(r),q=(p,f={})=>{p.preventDefault();const w=P(C);w&&(K({content:w,role:"user",createdAt:new Date},f),C.set(""))},ee=ge([E,_],([p,f])=>p||f);return{messages:v,error:x,append:K,reload:L,stop:Y,setMessages:Z,input:C,handleSubmit:q,isLoading:ee}}function Ve(e){let t,s,r;const a=e[1].default,n=ae(a,e,e[0],null);return{c(){t=T("main"),s=T("div"),n&&n.c(),this.h()},l(i){t=j(i,"MAIN",{class:!0});var o=R(t);s=j(o,"DIV",{class:!0});var c=R(s);n&&n.l(c),c.forEach(F),o.forEach(F),this.h()},h(){V(s,"class","flex-1 flex flex-col max-h-[calc(100dvh-1rem)] md:max-h-[calc(100dvh-4.5rem)] overflow-scroll gap-2"),V(t,"class","mt-2 ml-2 flex flex-col flex-1 gap-2")},m(i,o){oe(i,t,o),le(t,s),n&&n.m(s,null),r=!0},p(i,[o]){n&&n.p&&(!r||o&1)&&ce(n,a,i,i[0],r?de(a,i[0],o,null):ue(i[0]),null)},i(i){r||(pe(n,i),r=!0)},o(i){be(n,i),r=!1},d(i){i&&F(t),n&&n.d(i)}}}function Je(e,t,s){let{$$slots:r={},$$scope:a}=t;const{setMessages:n,input:i,handleSubmit:o,messages:c,isLoading:l,append:u}=Re();return he("chat",{setMessages:n,input:i,handleSubmit:o,messages:c,isLoading:l,append:u}),e.$$set=d=>{"$$scope"in d&&s(0,a=d.$$scope)},[a,r]}class He extends fe{constructor(t){super(),ve(this,t,Je,Ve,ie,{})}}export{He as component};
